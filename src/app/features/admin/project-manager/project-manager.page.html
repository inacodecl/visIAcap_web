<ion-header class="ion-no-border header-inacap">
    <div class="top-section">
        <div class="header-content">
            <ion-buttons slot="start" class="menu-btn-container">
                <ion-menu-button color="light"></ion-menu-button>
            </ion-buttons>

            <div class="logo-container">
                <img src="assets/icon/logo-inacap-60.png" alt="Logo Inacap" class="logo-placeholder">
            </div>

            <div class="header-text">
                <span class="sede-text">SEDE<br>RENCA (ADMIN)</span>
            </div>
        </div>
    </div>
</ion-header>

<ion-content [fullscreen]="true" [scrollY]="true" class="admin-content">
    <div class="glass-container">

        <h1 class="page-title">
            <ion-icon name="rocket"></ion-icon>
            Gestión de Proyectos (Presente)
        </h1>

        <!-- Search Bar -->
        <div class="search-wrapper">
            <ion-searchbar placeholder="Buscar proyectos..." [debounce]="250"
                (ionInput)="searchTerm.set($any($event).target.value)" animated="true" class="neon-searchbar">
            </ion-searchbar>
        </div>

        <!-- Status -->
        <div class="status-summary">
            <p>Proyectos Activos: <span class="highlight">{{ filteredProyectos().length }}</span> registros encontrados.
            </p>
        </div>

        <!-- Grid de Tarjetas -->
        <ion-grid>
            <ion-row>
                <ion-col size="12" size-md="6" size-xl="4" *ngFor="let item of filteredProyectos()">
                    <ion-card class="glass-card" [class.unpublished-item]="!item.is_published">
                        <div class="card-glow"></div>
                        <ion-card-header>
                            <div class="header-row">
                                <div class="slug-badge">{{ item.slug }}</div>
                                <ion-badge [color]="item.is_published ? 'success' : 'medium'" class="status-badge">
                                    {{ item.is_published ? 'PUBLICADO' : 'BORRADOR' }}
                                </ion-badge>
                            </div>
                            <ion-card-title>{{ item.titulo }}</ion-card-title>
                        </ion-card-header>
                        <ion-card-content>
                            <p class="description" *ngIf="item.resumen">{{ item.resumen | slice:0:120 }}...</p>
                            <p class="location" *ngIf="item.location">
                                <ion-icon name="globe"></ion-icon> {{ item.location }}
                            </p>

                            <div class="actions-panel">
                                <div class="buttons">
                                    <ion-button fill="clear" color="secondary" (click)="openEditModal(item)"
                                        class="action-btn edit-btn">
                                        <ion-icon slot="icon-only" name="create"></ion-icon>
                                    </ion-button>
                                    <ion-button fill="clear" color="danger" (click)="deleteProyecto(item.id)"
                                        class="action-btn delete-btn">
                                        <ion-icon slot="icon-only" name="trash"></ion-icon>
                                    </ion-button>
                                </div>
                            </div>
                        </ion-card-content>
                    </ion-card>
                </ion-col>
            </ion-row>
        </ion-grid>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="filteredProyectos().length === 0">
            <div class="hologram-circle"></div>
            <p>No se encontraron proyectos.</p>
        </div>

        <!-- Modal Formulario -->
        <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" class="glass-modal">
            <ng-template>
                <ion-header class="modal-header">
                    <ion-toolbar color="dark">
                        <ion-title>{{ isEditing ? 'Editando Proyecto #' + currentEditingId : 'Nuevo Proyecto'
                            }}</ion-title>
                        <ion-buttons slot="end">
                            <ion-button (click)="closeModal()">
                                <ion-icon name="close"></ion-icon>
                            </ion-button>
                        </ion-buttons>
                    </ion-toolbar>
                </ion-header>
                <div class="ion-padding modal-body">
                    <form [formGroup]="projectForm" (ngSubmit)="saveProyecto()">

                        <div class="form-grid">
                            <!-- Slug -->
                            <div class="form-group">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">Slug (URL) <span class="required">*</span></ion-label>
                                    <ion-input type="text" formControlName="slug"
                                        placeholder="mi-proyecto-ejemplo"></ion-input>
                                    <ion-note slot="helper">Solo minúsculas, números y guiones</ion-note>
                                    <ion-note slot="error"
                                        *ngIf="projectForm.get('slug')?.hasError('required')">Requerido</ion-note>
                                    <ion-note slot="error" *ngIf="projectForm.get('slug')?.hasError('pattern')">Formato
                                        inválido</ion-note>
                                </ion-item>
                            </div>

                            <!-- Título -->
                            <div class="form-group">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">Título <span class="required">*</span></ion-label>
                                    <ion-input type="text" formControlName="titulo"
                                        placeholder="Nombre del proyecto"></ion-input>
                                    <ion-note slot="helper">Max 150 caracteres</ion-note>
                                </ion-item>
                            </div>

                            <!-- Resumen -->
                            <div class="form-group full-width">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">Resumen</ion-label>
                                    <ion-textarea formControlName="resumen" rows="3"
                                        placeholder="Breve descripción..."></ion-textarea>
                                </ion-item>
                            </div>

                            <!-- Descripción -->
                            <div class="form-group full-width">
                                <ion-item class="input-item description-item" lines="none">
                                    <ion-label position="stacked">Descripción Completa</ion-label>
                                    <ion-textarea formControlName="descripcion" rows="8"
                                        placeholder="Descripción detallada del proyecto..."></ion-textarea>
                                </ion-item>
                            </div>

                            <!-- Fechas -->
                            <div class="form-group">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">Fecha Inicio</ion-label>
                                    <ion-input type="date" formControlName="start_date"></ion-input>
                                </ion-item>
                            </div>
                            <div class="form-group">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">Fecha Fin</ion-label>
                                    <ion-input type="date" formControlName="end_date"></ion-input>
                                </ion-item>
                            </div>

                            <!-- Ubicación -->
                            <div class="form-group">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">Ubicación</ion-label>
                                    <ion-input type="text" formControlName="location"
                                        placeholder="Ej: Renca, Chile"></ion-input>
                                </ion-item>
                            </div>

                            <!-- URL Externa -->
                            <div class="form-group">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">URL Externa</ion-label>
                                    <ion-input type="url" formControlName="url_externa"
                                        placeholder="https://..."></ion-input>
                                </ion-item>
                            </div>

                            <!-- Imagen Cover URL -->
                            <div class="form-group full-width">
                                <ion-item class="input-item" lines="none">
                                    <ion-label position="stacked">URL Imagen Portada</ion-label>
                                    <ion-input type="url" formControlName="image_cover_url"
                                        placeholder="https://...imagen.jpg"></ion-input>
                                </ion-item>
                            </div>

                            <!-- Toggles -->
                            <div class="form-group full-width settings-group">
                                <h3>Configuración</h3>
                                <div class="settings-grid">
                                    <ion-item lines="none" class="input-item toggle-box">
                                        <ion-icon name="eye" slot="start" size="small"></ion-icon>
                                        <ion-label>
                                            <h2>Publicado</h2>
                                            <p>Visible públicamente</p>
                                        </ion-label>
                                        <ion-toggle slot="end" formControlName="is_published"
                                            color="success"></ion-toggle>
                                    </ion-item>
                                    <ion-item lines="none" class="input-item toggle-box">
                                        <ion-icon name="rocket" slot="start" size="small"></ion-icon>
                                        <ion-label>
                                            <h2>Destacado</h2>
                                            <p>Mostrar en portada</p>
                                        </ion-label>
                                        <ion-toggle slot="end" formControlName="featured" color="warning"></ion-toggle>
                                    </ion-item>
                                </div>
                            </div>
                        </div>

                        <div class="modal-actions ion-margin-top">
                            <ion-button fill="outline" color="medium" (click)="closeModal()">Cancelar</ion-button>
                            <ion-button type="submit" [disabled]="projectForm.invalid || isLoading" color="danger"
                                class="save-btn">
                                <ion-icon slot="start" [name]="isLoading ? 'hourglass' : 'save'"></ion-icon>
                                {{ isLoading ? 'Procesando...' : 'Guardar Proyecto' }}
                            </ion-button>
                        </div>

                    </form>
                </div>
            </ng-template>
        </ion-modal>

        <div class="fab-spacer"></div>
    </div>
    <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="fixed-fab">
        <ion-fab-button color="danger" (click)="openCreateModal()" class="create-fab">
            <ion-icon name="add"></ion-icon>
        </ion-fab-button>
    </ion-fab>
</ion-content>