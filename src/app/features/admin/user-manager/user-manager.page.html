<ion-header class="ion-no-border header-inacap">
    <div class="top-section">
        <div class="header-content">
            <ion-buttons slot="start" class="menu-btn-container">
                <ion-back-button defaultHref="/admin/dashboard" color="light"></ion-back-button>
            </ion-buttons>

            <div class="logo-container">
                <img src="assets/icon/logo-inacap-60-v2.png" alt="Logo Inacap" class="logo-placeholder">
            </div>

            <div class="header-text">
                <span class="sede-text">SEDE<br>RENCA (ADMIN)</span>
            </div>
        </div>
    </div>
</ion-header>

<ion-content [fullscreen]="true" [scrollY]="true" class="admin-content">
    <ion-grid class="glass-container-grid">

        <!-- HEADER ROW: T√≠tulo + Buscador -->
        <ion-row class="ion-align-items-center ion-justify-content-between page-header-row">
            <ion-col size="12" size-md="6">
                <h1 class="page-title">
                    <ion-icon name="people"></ion-icon>
                    Gesti√≥n de Usuarios
                </h1>
            </ion-col>
            <ion-col size="12" size-md="6" class="ion-text-end search-col">
                <div class="search-wrapper">
                    <ion-searchbar placeholder="Buscar por nombre o email..." [debounce]="250"
                        (ionInput)="searchTerm.set($any($event).target.value)" animated="true" class="neon-searchbar">
                    </ion-searchbar>
                </div>
            </ion-col>
        </ion-row>

        <!-- ACTION CARDS -->
        <ion-row class="ion-margin-bottom">
            <!-- NEW USER CARD (Left aligned) -->
            <ion-col size="12" size-sm="12" size-md="12" size-lg="10" size-xl="6">
                <div class="quick-card" (click)="openCreateModal()">
                    <div class="icon-bg"><ion-icon name="person-add"></ion-icon></div>
                    <div class="content">
                        <h3>Crear Nuevo Usuario</h3>
                        <p>Registrar un nuevo administrador en la plataforma</p>
                    </div>
                    <ion-icon name="arrow-forward" class="arrow-icon"></ion-icon>
                </div>
            </ion-col>
        </ion-row>

        <ion-row class="ion-justify-content-center ion-margin-bottom">
            <ion-col size="12" class="ion-text-center">
                <div class="status-summary">
                    <p>Mostrando <span class="highlight">{{ filteredUsers().length }}</span> usuarios</p>
                </div>
            </ion-col>
        </ion-row>

        <!-- Loading State -->
        <ion-row *ngIf="isLoading">
            <ion-col size="12" class="ion-text-center ion-padding">
                <ion-spinner color="light"></ion-spinner>
            </ion-col>
        </ion-row>

        <!-- LIST GRID (USERS) -->
        <ion-row *ngIf="!isLoading">
            <!-- 
                XS (M√≥vil): 1 columna
                MD (Tablet): 2 columnas
                LG/XL (Desktop): 3 columnas (M√°s anchas, llenan mejor la pantalla)
            -->
            <ion-col size="12" size-sm="12" size-md="6" size-lg="4" size-xl="4" *ngFor="let user of filteredUsers()"
                class="user-card-column">
                <ion-card class="glass-card">
                    <div class="card-glow"></div>

                    <!-- 1. Header Visual (Avatar + Rol) -->
                    <div class="card-visual-header">
                        <div class="avatar-wrapper">
                            <div class="avatar-container">
                                <ion-icon name="person"></ion-icon>
                            </div>
                        </div>
                        <span class="role-badge" [ngClass]="user.rol">
                            {{ user.rol === 'super_admin' ? 'Super Admin' : user.rol }}
                        </span>
                    </div>

                    <ion-card-content>
                        <!-- 2. Informaci√≥n Usuario (Nombre + Correo) -->
                        <div class="user-info-section">
                            <h3 class="user-name">{{ user.nombre }} {{ user.apellido }}</h3>
                            <p class="user-email">{{ user.email }}</p>
                        </div>

                        <!-- 3. Acciones (Bottom) -->
                        <div class="actions-panel">
                            <!-- Status Toggle -->
                            <div class="status-toggle" [class.active]="user.is_active">
                                <ion-toggle [checked]="user.is_active" (ionChange)="toggleUserStatus(user, $event)"
                                    mode="ios" color="success">
                                </ion-toggle>
                                <span>{{ user.is_active ? 'Activo' : 'Inactivo' }}</span>
                            </div>

                            <!-- Buttons -->
                            <div class="buttons">
                                <ion-button fill="clear" color="warning" (click)="openEditModal(user)"
                                    title="Editar Usuario">
                                    <ion-icon slot="icon-only" name="create"></ion-icon>
                                </ion-button>

                                <ion-button fill="clear" color="danger" (click)="deleteUser(user.id)"
                                    title="Eliminar Usuario">
                                    <ion-icon slot="icon-only" name="trash"></ion-icon>
                                </ion-button>
                            </div>
                        </div>
                    </ion-card-content>
                </ion-card>
            </ion-col>
        </ion-row>

        <!-- Empty State -->
        <ion-row *ngIf="!isLoading && filteredUsers().length === 0">
            <ion-col size="12">
                <div class="empty-state">
                    <div class="hologram-circle"></div>
                    <p>No se encontraron otros usuarios.</p>
                </div>
            </ion-col>
        </ion-row>

    </ion-grid>

    <!-- Modal Formulario Redise√±ado -->
    <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" class="user-modal-neon">
        <ng-template>
            <div class="modal-wrapper-custom">
                <!-- Header con Gradiente -->
                <div class="modal-header-neon">
                    <div class="header-text">
                        <h2>{{ isEditMode ? 'Editar' : 'Nuevo' }} <span>Usuario</span></h2>
                        <p>{{ isEditMode ? 'Modificar datos de acceso' : 'Complete los datos para registrar acceso' }}
                        </p>
                    </div>
                    <ion-button fill="clear" color="light" class="close-btn" (click)="closeModal()">
                        <ion-icon name="close" slot="icon-only"></ion-icon>
                    </ion-button>
                </div>

                <!-- Body Est√°tico (sin scroll) -->
                <div class="modal-body-static">
                    <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="slide-in-form">

                        <div class="form-grid">
                            <ion-item class="form-item-neon" lines="none">
                                <ion-icon name="person" slot="start" class="input-icon"></ion-icon>
                                <ion-input label="Nombre" labelPlacement="floating"
                                    formControlName="nombre"></ion-input>
                            </ion-item>

                            <ion-item class="form-item-neon" lines="none">
                                <ion-icon name="person" slot="start" class="input-icon"></ion-icon>
                                <ion-input label="Apellido" labelPlacement="floating"
                                    formControlName="apellido"></ion-input>
                            </ion-item>

                            <ion-item class="form-item-neon full-width" lines="none">
                                <ion-icon name="mail" slot="start" class="input-icon"></ion-icon>
                                <ion-input label="Correo Electr√≥nico" labelPlacement="floating" type="email"
                                    formControlName="email"></ion-input>
                            </ion-item>

                            <ion-item class="form-item-neon full-width" lines="none">
                                <ion-icon name="lock-closed" slot="start" class="input-icon"></ion-icon>
                                <ion-input label="Contrase√±a {{ isEditMode ? '(Opcional)' : '' }}"
                                    labelPlacement="floating" type="password" formControlName="password"></ion-input>
                            </ion-item>

                            <!-- Nota informativa si es edici√≥n -->
                            <div class="input-note" *ngIf="isEditMode">
                                <small style="color: var(--neon-blue); padding-left: 10px;">Dejar en blanco para
                                    mantener la contrase√±a actual.</small>
                            </div>

                            <ion-item class="form-item-neon full-width" lines="none">
                                <ion-icon name="shield" slot="start" class="input-icon"></ion-icon>
                                <ion-select label="Rol de Usuario" labelPlacement="floating" formControlName="rol"
                                    interface="popover">
                                    <ion-select-option value="super_admin">‚ö° Super Admin (Acceso
                                        Total)</ion-select-option>
                                    <ion-select-option value="admin">üîß Admin (Gesti√≥n de Contenido)</ion-select-option>
                                </ion-select>
                            </ion-item>
                        </div>

                        <div class="modal-actions">
                            <ion-button expand="block" type="submit" [disabled]="userForm.invalid || isLoading"
                                class="create-btn-neon">
                                <ion-icon name="rocket" slot="start"></ion-icon>
                                {{ isLoading ? 'Procesando...' : (isEditMode ? 'Guardar Cambios' : 'Crear Cuenta') }}
                            </ion-button>
                        </div>

                    </form>
                </div>
            </div>
        </ng-template>
    </ion-modal>

</ion-content>